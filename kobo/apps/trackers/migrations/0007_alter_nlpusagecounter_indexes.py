# flake8: noqa: E501
# Generated by Django 4.2.24 on 2026-01-09 15:02

from django.conf import settings
from django.db import migrations, models
from django.db.models import Q


def manually_create_constraints_instructions(apps, schema_editor):
    print(
        """
        ⚠️ ATTENTION ⚠️
        Run the SQL queries below in PostgreSQL directly:

            -- 1) (Optional) Drop old index if it exists (in case you renamed it)
            DROP INDEX CONCURRENTLY IF EXISTS "trackers_mo_year_72676f_idx";

            -- 2) Create the regular (non-unique) index that Django would create
            CREATE INDEX CONCURRENTLY IF NOT EXISTS "trackers_nl_date_552b2e_idx"
              ON "trackers_nlpusagecounter" ("date", "user_id");

            -- 3) unique_with_asset (unique on date, user, asset)
            CREATE UNIQUE INDEX CONCURRENTLY IF NOT EXISTS "unique_with_asset_idx"
              ON "trackers_nlpusagecounter" ("date", "user_id", "asset_id");

            -- Add the UNIQUE constraint only if it does not exist
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1
                    FROM pg_constraint
                    WHERE conname = 'unique_with_asset'
                ) THEN
                    ALTER TABLE "trackers_nlpusagecounter"
                        ADD CONSTRAINT "unique_with_asset"
                        UNIQUE USING INDEX "unique_with_asset_idx";
                END IF;
            END
            $$;

            -- 4) unique_without_asset (partial unique: asset_id IS NULL)
            CREATE UNIQUE INDEX CONCURRENTLY IF NOT EXISTS "unique_without_asset"
              ON "trackers_nlpusagecounter" ("date", "user_id")
              WHERE "asset_id" IS NULL;

        """
    )


def manually_drop_constraints_instructions(apps, schema_editor):
    print(
        """
        ⚠️ ATTENTION ⚠️
        Run the SQL queries below in PostgreSQL directly:

            -- Drop constraints / indexes created in the forward manual steps
            ALTER TABLE "trackers_nlpusagecounter" DROP CONSTRAINT IF EXISTS "unique_with_asset";

            DROP INDEX CONCURRENTLY IF EXISTS "unique_with_asset_idx";
            DROP INDEX CONCURRENTLY IF EXISTS "unique_without_asset";
            DROP INDEX CONCURRENTLY IF EXISTS "trackers_nl_date_552b2e_idx";

        """
    )


def get_conditional_operations():
    if settings.SKIP_HEAVY_MIGRATIONS:
        return [
            migrations.RunPython(
                manually_create_constraints_instructions,
                manually_drop_constraints_instructions,
            )
        ]

    # Not skipping: let Django apply the real schema changes
    return [
        migrations.AddIndex(
            model_name='nlpusagecounter',
            index=models.Index(
                fields=['date', 'user'],
                name='trackers_nl_date_552b2e_idx',
            ),
        ),
        migrations.AddConstraint(
            model_name='nlpusagecounter',
            constraint=models.UniqueConstraint(
                fields=('date', 'user', 'asset'),
                name='unique_with_asset',
            ),
        ),
        migrations.AddConstraint(
            model_name='nlpusagecounter',
            constraint=models.UniqueConstraint(
                condition=Q(('asset', None)),
                fields=('date', 'user'),
                name='unique_without_asset',
            ),
        ),
    ]


class Migration(migrations.Migration):

    dependencies = [
        ('kpi', '0070_alter_kpi_models_options'),
        ('trackers', '0006_add_total_llm_requests'),
    ]

    operations = [
        migrations.AlterField(
            model_name='nlpusagecounter',
            name='date',
            field=models.DateField(),
        ),
        *get_conditional_operations(),
    ]
