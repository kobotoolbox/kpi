# Generated by hand to extend InsightZen quota management schema.
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ('insightzen_core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='QuotaScheme',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=128)),
                ('version', models.PositiveIntegerField(default=1)),
                (
                    'status',
                    models.CharField(
                        choices=[('draft', 'Draft'), ('published', 'Published'), ('archived', 'Archived')],
                        default='draft',
                        max_length=16,
                    ),
                ),
                ('dimensions', models.JSONField(default=list)),
                (
                    'overflow_policy',
                    models.CharField(
                        choices=[('strict', 'Strict'), ('soft', 'Soft'), ('weighted', 'Weighted')],
                        default='strict',
                        max_length=16,
                    ),
                ),
                ('priority', models.IntegerField(default=0)),
                ('is_default', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('published_at', models.DateTimeField(blank=True, null=True)),
            ],
            options={
                'verbose_name': 'Quota scheme',
                'verbose_name_plural': 'Quota schemes',
                'unique_together': {('project', 'name', 'version')},
            },
        ),
        migrations.CreateModel(
            name='SampleContact',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('phone', models.CharField(db_index=True, max_length=32)),
                ('gender', models.CharField(blank=True, max_length=16, null=True)),
                ('age_band', models.CharField(blank=True, max_length=16, null=True)),
                ('province_code', models.CharField(blank=True, max_length=4, null=True)),
                ('extra', models.JSONField(blank=True, default=dict)),
                ('is_active', models.BooleanField(default=True)),
                ('used_at', models.DateTimeField(blank=True, null=True)),
            ],
            options={
                'verbose_name': 'Sample contact',
                'verbose_name_plural': 'Sample contacts',
            },
        ),
        migrations.CreateModel(
            name='QuotaCell',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('selector', models.JSONField()),
                ('label', models.CharField(blank=True, max_length=256)),
                ('target', models.PositiveIntegerField()),
                ('soft_cap', models.PositiveIntegerField(blank=True, null=True)),
                ('weight', models.FloatField(default=1.0)),
                ('achieved', models.PositiveIntegerField(default=0)),
                ('in_progress', models.PositiveIntegerField(default=0)),
                ('reserved', models.PositiveIntegerField(default=0)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                (
                    'scheme',
                    models.ForeignKey(
                        on_delete=models.deletion.CASCADE,
                        related_name='cells',
                        to='insightzen_core.quotascheme',
                    ),
                ),
            ],
            options={
                'verbose_name': 'Quota cell',
                'verbose_name_plural': 'Quota cells',
            },
        ),
        migrations.CreateModel(
            name='DialerAssignment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                (
                    'status',
                    models.CharField(
                        choices=[
                            ('reserved', 'Reserved'),
                            ('completed', 'Completed'),
                            ('failed', 'Failed'),
                            ('expired', 'Expired'),
                            ('cancelled', 'Cancelled'),
                        ],
                        default='reserved',
                        max_length=16,
                    ),
                ),
                ('reserved_at', models.DateTimeField(auto_now_add=True)),
                ('expires_at', models.DateTimeField()),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('outcome_code', models.CharField(blank=True, max_length=8, null=True)),
                ('meta', models.JSONField(blank=True, default=dict)),
                (
                    'cell',
                    models.ForeignKey(
                        on_delete=models.deletion.PROTECT,
                        related_name='assignments',
                        to='insightzen_core.quotacell',
                    ),
                ),
                (
                    'interviewer',
                    models.ForeignKey(
                        on_delete=models.deletion.PROTECT,
                        related_name='quota_assignments',
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    'project',
                    models.ForeignKey(
                        on_delete=models.deletion.CASCADE,
                        related_name='assignments',
                        to='insightzen_core.insightproject',
                    ),
                ),
                (
                    'sample',
                    models.ForeignKey(
                        on_delete=models.deletion.PROTECT,
                        related_name='assignments',
                        to='insightzen_core.samplecontact',
                    ),
                ),
                (
                    'scheme',
                    models.ForeignKey(
                        on_delete=models.deletion.PROTECT,
                        related_name='+',
                        to='insightzen_core.quotascheme',
                    ),
                ),
            ],
            options={
                'verbose_name': 'Dialer assignment',
                'verbose_name_plural': 'Dialer assignments',
            },
        ),
        migrations.AddField(
            model_name='quotascheme',
            name='created_by',
            field=models.ForeignKey(on_delete=models.deletion.PROTECT, related_name='+', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='quotascheme',
            name='project',
            field=models.ForeignKey(
                on_delete=models.deletion.CASCADE,
                related_name='quota_schemes',
                to='insightzen_core.insightproject',
            ),
        ),
        migrations.AddField(
            model_name='samplecontact',
            name='project',
            field=models.ForeignKey(
                on_delete=models.deletion.CASCADE,
                related_name='samples',
                to='insightzen_core.insightproject',
            ),
        ),
        migrations.AddConstraint(
            model_name='quotacell',
            constraint=models.UniqueConstraint(fields=('scheme', 'selector'), name='unique_quota_cell_selector'),
        ),
        migrations.AddIndex(
            model_name='quotacell',
            index=models.Index(fields=['scheme'], name='insightzen__quota_cell_scheme_idx'),
        ),
        migrations.AddIndex(
            model_name='quotascheme',
            index=models.Index(fields=['project', 'status'], name='insightzen__quota_scheme_status_idx'),
        ),
        migrations.AddIndex(
            model_name='quotascheme',
            index=models.Index(fields=['project', 'is_default'], name='insightzen__quota_scheme_default_idx'),
        ),
        migrations.AddIndex(
            model_name='quotascheme',
            index=models.Index(fields=['priority', 'published_at'], name='insightzen__quota_scheme_priority_idx'),
        ),
        migrations.AddIndex(
            model_name='samplecontact',
            index=models.Index(fields=['project', 'is_active'], name='insightzen__sample_active_idx'),
        ),
        migrations.AddIndex(
            model_name='dialerassignment',
            index=models.Index(fields=['project', 'status'], name='insightzen__dialer_project_status_idx'),
        ),
        migrations.AddIndex(
            model_name='dialerassignment',
            index=models.Index(fields=['cell', 'status'], name='insightzen__dialer_cell_status_idx'),
        ),
        migrations.AddIndex(
            model_name='dialerassignment',
            index=models.Index(fields=['sample', 'status'], name='insightzen__dialer_sample_status_idx'),
        ),
    ]
