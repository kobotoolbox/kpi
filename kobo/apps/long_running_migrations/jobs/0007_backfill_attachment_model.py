# Generated by Django 4.2.15 on 2025-03-12 14:37
from more_itertools import chunked

from kobo.apps.openrosa.apps.logger.models.attachment import (
    Attachment,
    AttachmentDeleteStatus,
)
from kpi.fields.kpi_uid import KpiUidField


def run():
    """
    Backfills xform_id, user_id, uid, date_created, and date_modified for Attachment
    model.
    """
    CHUNK_SIZE = 2000

    attachments = (
        Attachment.all_objects.only(
            'instance_id',
            'deleted_at',
            'date_created',
            'instance__date_created',
            'instance__xform_id',
            'instance__xform__user_id',
        )
    ).iterator(CHUNK_SIZE)

    for attachment_batch in chunked(attachments, CHUNK_SIZE):
        for attachment in attachment_batch:
            instance = attachment.instance
            xform = instance.xform
            user = xform.user

            attachment.xform_id = xform.id
            attachment.user_id = user.id

            if not attachment.uid:
                attachment.uid = KpiUidField.generate_unique_id('att')

            if not attachment.date_created:
                attachment.date_created = instance.date_created

            if not attachment.date_modified:
                attachment.date_modified = attachment.date_created

            if attachment.deleted_at and not attachment.delete_status:
                attachment.date_modified = attachment.deleted_at
                attachment.delete_status = AttachmentDeleteStatus.SOFT_DELETED

        Attachment.all_objects.bulk_update(
            attachment_batch,
            fields=[
                'xform_id',
                'user_id',
                'uid',
                'date_created',
                'date_modified',
                'delete_status',
            ],
        )
